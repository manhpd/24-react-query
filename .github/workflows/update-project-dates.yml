name: Auto Set Start Date on Branch Create

on:
  create:
    branches:
      - '*'
permissions:
  issues: write
  contents: read
  
jobs:
  set_start_date:
    runs-on: ubuntu-latest

    steps:
      - name: Check if branch is linked to issue
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
          BRANCH: ${{ github.ref_name }}
        run: |
          echo "Branch created: $BRANCH"
          
          # 1Ô∏è‚É£ T√¨m issue number trong t√™n branch (v√≠ d·ª• feature/123-add-login)
          ISSUE_NUMBER=$(echo "$BRANCH" | grep -oE '[0-9]+' | head -n 1)
          
          if [ -z "$ISSUE_NUMBER" ]; then
            echo "‚ùå No issue number found in branch name."
            exit 0
          fi
          
          echo "‚úÖ Found issue number: $ISSUE_NUMBER"

          # 2Ô∏è‚É£ Ki·ªÉm tra issue c√≥ t·ªìn t·∫°i kh√¥ng
          ISSUE=$(gh api repos/$REPO/issues/$ISSUE_NUMBER --jq '.number' || echo "")
          if [ -z "$ISSUE" ]; then
            echo "‚ùå Issue #$ISSUE_NUMBER not found in $REPO."
            exit 0
          fi

          # 3Ô∏è‚É£ Set startDate = now (ISO 8601 UTC)
          START_DATE=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

          echo "üïí Setting start date for issue #$ISSUE_NUMBER ‚Üí $START_DATE"

          # 4Ô∏è‚É£ Update issue body (append ho·∫∑c ghi ƒë√® n·∫øu c·∫ßn)
          BODY=$(gh api repos/$REPO/issues/$ISSUE_NUMBER --jq '.body')
          NEW_BODY="$BODY\n\n**Start Date:** $START_DATE"

          gh api \
            --method PATCH \
            -H "Accept: application/vnd.github+json" \
            repos/$REPO/issues/$ISSUE_NUMBER \
            -f body="$NEW_BODY"

          echo "‚úÖ Issue #$ISSUE_NUMBER updated with start date."
